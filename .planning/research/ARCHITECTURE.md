# ARCHITECTURE.md — Codebase Analysis (Edge Refactor)

## Current Component Map

```
┌─────────────────────────────────────────────────────────┐
│                    kedge hub                            │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Virtual Workspaces (pkg/virtual/builder/)       │   │
│  │  ┌──────────────┐ ┌─────────────┐ ┌──────────┐  │   │
│  │  │ edge-proxy   │ │ agent-proxy │ │cluster-  │  │   │
│  │  │ (tunnel reg) │ │ (k8s / ssh) │ │ proxy    │  │   │
│  │  └──────┬───────┘ └──────┬──────┘ └──────────┘  │   │
│  └─────────│────────────────│────────────────────────┘  │
│            │                │                           │
│  ┌─────────▼────────────────▼──────────────────────┐   │
│  │  connman.ConnectionManager (pkg/util/connman/)   │   │
│  │  key: "cluster/name" or "cluster/servers/name"  │   │
│  └────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Hub Controllers (pkg/hub/controllers/)          │   │
│  │  site/: lifecycle, mount, rbac reconcilers       │   │
│  │  scheduler/: placement scheduler                 │   │
│  │  status/: aggregator                             │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    kedge agent                          │
│  pkg/agent/agent.go                                     │
│    ├── mode=site: starts downstream k8s + reconciler    │
│    │   status/reporter.go    (Site heartbeats)          │
│    │   reconciler/workload.go (placement sync)          │
│    └── mode=server: SSH proxy only                      │
│        status/server_reporter.go (Server heartbeats)    │
│        tunnel/tunneler.go + server.go                   │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    kedge CLI                            │
│  pkg/cli/cmd/                                           │
│    ssh.go — resolveResourceKind probe + WS dial         │
│    site.go — site management commands                   │
│    agent.go — agent join (--mode flag)                  │
└─────────────────────────────────────────────────────────┘
```

## Target Component Map (post-refactor)

```
┌─────────────────────────────────────────────────────────┐
│                    kedge hub                            │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Virtual Workspaces                              │   │
│  │  ┌─────────────────────────┐ ┌──────────────┐   │   │
│  │  │      edges-proxy        │ │ cluster-     │   │   │
│  │  │  /register (tunnel reg) │ │  proxy       │   │   │
│  │  │  /...edges/{name}/k8s   │ └──────────────┘   │   │
│  │  │  /...edges/{name}/ssh   │                    │   │
│  │  └────────────┬────────────┘                    │   │
│  └───────────────│────────────────────────────────────┘  │
│                  │                                       │
│  ┌───────────────▼──────────────────────────────────┐   │
│  │  connman.ConnectionManager                        │   │
│  │  key: "cluster/name"  (no type prefix)            │   │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Hub Controllers                                 │   │
│  │  edge/: lifecycle, mount (k8s only), rbac        │   │
│  │  scheduler/, status/ (unchanged)                 │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    kedge agent                          │
│  pkg/agent/agent.go                                     │
│    ├── type=kubernetes: k8s client + reconciler          │
│    │   status/edge_reporter.go  (Edge heartbeats)       │
│    │   reconciler/workload.go   (unchanged)              │
│    └── type=server: SSH proxy only                      │
│        status/edge_reporter.go  (Edge heartbeats)       │
│        tunnel/tunneler.go + server.go (unchanged)       │
└─────────────────────────────────────────────────────────┘
```

## Key Invariants to Preserve

1. **connman interface** (`pkg/util/connman/connman.go`) — `Set(key, conn)` / `Get(key)` / `Del(key)` — **do not change the connman package itself**; only change the keys generated by callers

2. **revdial protocol** (`pkg/util/revdial/`) — WebSocket reverse-dial protocol — **unchanged**

3. **SSH proxy logic** (`pkg/util/ssh/`, `pkg/agent/tunnel/`) — the actual SSH tunneling code — **unchanged**, just rewired

4. **OIDC auth** (`pkg/server/auth/`, `pkg/cli/auth/`) — untouched

5. **Placement / Scheduler** (`pkg/hub/controllers/scheduler/`, `pkg/agent/reconciler/`) — unchanged

6. **multicluster-runtime** pattern (`mcbuilder`, `mcmanager`, `mcreconcile`) — edge controllers must follow the same pattern as site controllers

## File Deletion List

| File/Dir | Reason |
|----------|--------|
| `apis/kedge/v1alpha1/types_site.go` | Replaced by types_edge.go |
| `apis/kedge/v1alpha1/types_server.go` | Replaced by types_edge.go |
| `pkg/hub/controllers/site/` (all files) | Replaced by pkg/hub/controllers/edge/ |
| `pkg/virtual/builder/edge_proxy_builder.go` | Merged into edges_proxy_builder.go |
| `pkg/virtual/builder/agent_proxy_builder.go` | Merged into edges_proxy_builder.go |
| `pkg/agent/status/reporter.go` | Replaced by edge_reporter.go |
| `pkg/agent/status/server_reporter.go` | Replaced by edge_reporter.go |

## File Creation List

| File | Contents |
|------|----------|
| `apis/kedge/v1alpha1/types_edge.go` | Edge/EdgeList/EdgeSpec/EdgeStatus types |
| `pkg/hub/controllers/edge/controller.go` | Constants + setup |
| `pkg/hub/controllers/edge/lifecycle_reconciler.go` | Heartbeat staleness |
| `pkg/hub/controllers/edge/mount_reconciler.go` | kcp workspace (k8s only) |
| `pkg/hub/controllers/edge/rbac_reconciler.go` | Workspace RBAC |
| `pkg/virtual/builder/edges_proxy_builder.go` | Unified VW handler |
| `pkg/agent/status/edge_reporter.go` | Unified reporter |
